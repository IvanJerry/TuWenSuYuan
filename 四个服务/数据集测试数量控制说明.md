# 数据集测试数量控制功能说明

## 功能概述

现在 `dataset_app.py` 支持控制数据集测试的样本数量，用户可以根据需要设置常规样本和水印样本的测试数量。

## 功能特性

### 1. 后端 API 支持

- **端点**: `POST /api/dataset_detection/start_dataset_test`
- **参数**:
  - `normal_samples_count`: 常规样本数量 (默认: 1000, 范围: 1-10000)
  - `watermark_samples_count`: 水印样本数量 (默认: 1000, 范围: 1-10000)

### 2. 前端界面

- 在数据集检测部分添加了样本数量控制输入框
- 用户可以直观地设置测试样本数量
- 包含输入验证，确保数量在合理范围内

### 3. 参数验证

- 样本数量必须大于 0
- 样本数量不能超过 10000
- 前端和后端都有验证机制

## 使用方法

### 1. 通过前端界面

1. 打开 `watermark.html` 页面
2. 在数据集检测部分找到样本数量控制区域
3. 设置常规样本数量和水印样本数量
4. 点击"启动检测引擎"按钮

### 2. 通过 API 调用

```bash
# 使用默认参数（1000个样本）
curl -X POST http://localhost:3001/api/dataset_detection/start_dataset_test

# 使用自定义参数
curl -X POST http://localhost:3001/api/dataset_detection/start_dataset_test \
  -H "Content-Type: application/json" \
  -d '{
    "normal_samples_count": 500,
    "watermark_samples_count": 500
  }'
```

### 3. 测试脚本

运行测试脚本验证功能：

```bash
cd 四个服务
python test_dataset_count.py
```

## 技术实现

### 1. 后端修改

- `dataset_app.py` 中的 `start_dataset_test` 函数支持接收参数
- `FAPEvaluator.test()` 方法支持控制测试样本数量
- 添加了参数验证和错误处理

### 2. 前端修改

- `watermark.html` 添加了样本数量输入框
- JavaScript 代码支持读取用户输入并发送到后端
- 添加了前端输入验证

### 3. 测试控制逻辑

- 在测试循环中跟踪已处理的样本数量
- 当达到目标数量时自动停止测试
- 保持进度更新和状态管理

## 示例响应

### 成功启动测试

```json
{
  "message": "数据集测试已开始",
  "status": "started",
  "test_params": {
    "normal_samples_count": 500,
    "watermark_samples_count": 500
  }
}
```

### 参数错误

```json
{
  "error": "样本数量必须大于0"
}
```

## 注意事项

1. **性能考虑**: 样本数量越多，测试时间越长
2. **内存使用**: 大量样本可能增加内存使用
3. **测试准确性**: 样本数量影响测试结果的统计显著性
4. **默认设置**: 建议使用 1000 个样本作为基准测试

## 故障排除

### 常见问题

1. **参数验证失败**: 确保样本数量在 1-10000 范围内
2. **测试不启动**: 检查后端服务是否正常运行
3. **进度不更新**: 检查网络连接和 API 端点

### 调试方法

1. 查看浏览器控制台错误信息
2. 检查后端日志输出
3. 使用测试脚本验证 API 功能
